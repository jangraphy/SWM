<!DOCTYPE html>
<html>
<head>
    <title>Smart Water Management</title>
</head>
<body>
    <h1>Water Level Measurement</h1>
    <p>Current Water Level: <span id="water-level">Measuring...</span> cm</p>

    <script>
        function updateWaterLevel() {
            fetch('/measure-distance') // Send a request to the server to measure the distance
                .then(response => response.json())
                .then(data => {
                    document.getElementById('water-level').textContent = data.distance.toFixed(2);
                })
                .catch(error => {
                    console.error(error);
                });
        }

        // Update the water level every 5 seconds (adjust as needed)
        setInterval(updateWaterLevel, 5000);
    </script>
</body>
</html>
from machine import Pin, time
import ujson
from usocket import socket

TRIGGER_PIN = 23
ECHO_PIN = 22

trigger = Pin(TRIGGER_PIN, Pin.OUT)
echo = Pin(ECHO_PIN, Pin.IN)

def measure_distance():
    trigger.value(0)
    time.sleep_us(5)
    trigger.value(1)
    time.sleep_us(10)
    trigger.value(0)

    pulse_start = pulse_end = 0
    while echo.value() == 0:
        pulse_start = time.ticks_us()

    while echo.value() == 1:
        pulse_end = time.ticks_us()

    pulse_duration = pulse_end - pulse_start
    distance = (pulse_duration * 0.0343) / 2

    return distance

def serve_webpage():
    s = socket()
    s.bind(('0.0.0.0', 80))
    s.listen(5)

    while True:
        conn, addr = s.accept()
        conn_file = conn.makefile('rwb', 0)
        request_line = conn_file.readline()
        method, path, _ = request_line.split(b' ')

        if method == b'GET' and path == b'/':
            conn.send('HTTP/1.1 200 OK\n')
            conn.send('Content-Type: text/html\n')
            conn.send('Connection: close\n\n')
            conn_file.write(open('water_management.html', 'r').read())
            conn.close()
        elif method == b'GET' and path == b'/measure-distance':
            distance = measure_distance()
            response = {'distance': distance}
            conn.send('HTTP/1.1 200 OK\n')
            conn.send('Content-Type: application/json\n')
            conn.send('Connection: close\n\n')
            conn.send(ujson.dumps(response))
            conn.close()

serve_webpage()
